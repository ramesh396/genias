<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Salapa Tutor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <style>
    /* UI CHANGE: Mobile-first layout + calmer palette to reduce visual clutter */
    :root {
      --bg: #120907;
      --panel: #1a0f0b;
      --panel-2: #0c0604;
      --border: rgba(255, 176, 120, 0.14);
      --text: #f7efe9;
      --muted: rgba(247, 239, 233, 0.68);
      --accent-1: #ffb066;
      --accent-2: #ff9f4a;
      --accent-3: #ff8a1f;
      --bubble-user: #2d1a14;
      --bubble-ai: #1a0f0b;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body { height: 100%; }

    body {
      font-family: Inter, system-ui, sans-serif;
      background: radial-gradient(circle at top, #241208 0%, var(--bg) 60%);
      color: var(--text);
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* UI CHANGE: Simple, quiet top bar (less cognitive load than big header) */
    .topbar {
      flex: 0 0 auto;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      background: rgba(26, 15, 11, 0.75);
      backdrop-filter: blur(10px);
    }

    .topbar__title {
      font-weight: 900;
      letter-spacing: 0.2px;
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2), var(--accent-3));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .topbar__hint {
      margin-top: 2px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    /* Chat */
    #chatbox {
      flex: 1 1 auto;
      overflow-y: auto;
      padding: 12px 12px 90px; /* bottom padding so messages never hide behind input */
      background: var(--panel-2);
      scroll-behavior: smooth;
    }

    .msg {
      margin: 10px 0;
      padding: 12px 14px;
      border-radius: 16px;
      font-size: 14.5px;
      line-height: 1.6;
      max-width: 86%;
      animation: fadeIn 0.22s ease;
      border: 1px solid rgba(255, 176, 120, 0.08);
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .user { background: var(--bubble-user); margin-left: auto; }
    .ai { background: var(--bubble-ai); margin-right: auto; }

    /* Image preview (kept, but visually quieter) */
    #imagePreview {
      display: none;
      padding: 10px 12px 0;
      background: var(--panel-2);
    }

    #previewImg {
      max-width: 180px;
      border-radius: 12px;
      border: 1px solid rgba(255, 176, 120, 0.28);
    }

    /* UI CHANGE: ChatGPT-like bottom bar (plus left, input center, mic + send on right) */
    #inputArea {
      flex: 0 0 auto;
      position: sticky;
      bottom: 0;
      background: rgba(26, 15, 11, 0.9);
      backdrop-filter: blur(12px);
      border-top: 1px solid var(--border);
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
    }

    .composer-row {
      display: grid;
      grid-template-columns: 44px 1fr auto;
      gap: 10px;
      align-items: end;
    }

    /* Plus + menu */
    .plus-container { position: relative; }

    .plus-btn {
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: 1px solid rgba(255, 176, 120, 0.3);
      background: rgba(255,255,255,0.03);
      color: var(--accent-1);
      font-size: 22px;
      font-weight: 900;
      cursor: pointer;
      transition: transform 0.12s ease, background 0.12s ease;
      touch-action: manipulation;
    }

    .plus-btn:hover { background: rgba(255,255,255,0.06); }
    .plus-btn:active { transform: scale(0.98); }

    .upload-menu {
      position: absolute;
      bottom: 52px;
      left: 0;
      width: min(320px, calc(100vw - 20px));
      background: var(--panel);
      border: 1px solid rgba(255, 176, 120, 0.18);
      border-radius: 14px;
      display: none;
      padding: 10px;
      z-index: 2000;
      box-shadow: 0 20px 60px rgba(0,0,0,0.55);
    }

    .menu-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: rgba(247, 239, 233, 0.55);
      margin: 8px 6px 6px;
    }

    .upload-option,
    .menu-btn {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 10px;
      cursor: pointer;
      color: var(--text);
      border-radius: 10px;
      transition: background 0.12s ease;
      border: 1px solid rgba(255,255,255,0.04);
      background: rgba(255,255,255,0.02);
      text-align: left;
      font-size: 14px;
      touch-action: manipulation;
    }

    .upload-option:hover,
    .menu-btn:hover { background: rgba(255,255,255,0.06); }

    .upload-option input { display: none; }

    .menu-row {
      display: flex;
      gap: 8px;
      padding: 6px 6px 2px;
    }

    .pill {
      flex: 1;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255, 176, 120, 0.18);
      background: rgba(255,255,255,0.03);
      color: var(--text);
      font-weight: 800;
      cursor: pointer;
      touch-action: manipulation;
    }

    .pill.active {
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2), var(--accent-3));
      color: #2a1408;
      border-color: rgba(255, 176, 120, 0.0);
    }

    select {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(255, 176, 120, 0.18);
      background: rgba(255,255,255,0.03);
      color: var(--text);
      outline: none;
    }

    .field {
      padding: 6px;
    }

    /* Input shell */
    .input-shell {
      position: relative;
      border: 1px solid rgba(255, 176, 120, 0.18);
      border-radius: 16px;
      background: rgba(255,255,255,0.03);
      display: flex;
      align-items: end;
      padding: 6px;
    }

    /* UI CHANGE: Textarea default height ~48px, auto-expands while typing */
    #question {
      width: 100%;
      min-height: 48px;
      max-height: 160px;
      resize: none;
      border: none;
      outline: none;
      padding: 10px 44px 10px 12px; /* right padding for mic button */
      background: transparent;
      color: var(--text);
      font-size: 15px;
      line-height: 1.35;
      overflow-y: auto;
    }

    #question::placeholder { color: rgba(247, 239, 233, 0.45); }

    .icon-btn {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: 1px solid rgba(255, 176, 120, 0.16);
      background: rgba(255,255,255,0.03);
      color: var(--accent-1);
      cursor: pointer;
      display: grid;
      place-items: center;
      touch-action: manipulation;
      transition: background 0.12s ease;
    }

    .icon-btn:hover { background: rgba(255,255,255,0.06); }

    .icon-btn.mic {
      position: absolute;
      right: 6px;
      bottom: 6px;
    }

    .send-btn {
      padding: 12px 16px;
      border-radius: 14px;
      border: none;
      cursor: pointer;
      font-weight: 900;
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2), var(--accent-3));
      color: #2a1408;
      height: 44px;
      touch-action: manipulation;
    }

    .send-btn:active { transform: translateY(1px); }

    /* Status */
    .status-row {
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      font-size: 12px;
      color: var(--muted);
      padding: 0 4px;
      min-height: 16px;
    }

    .status-warn { color: rgba(255, 176, 120, 0.88); }

    @media (min-width: 760px) {
      #chatbox { padding: 14px 10% 98px; }
      #inputArea { padding-left: 10%; padding-right: 10%; }
      .upload-menu { left: 0; }
    }
  </style>
</head>

<body>
  <!-- UI CHANGE: Simplified header with one clear message -->
  <header class="topbar">
    <div class="topbar__title">AI Tutor</div>
    <div class="topbar__hint">Ask a question or paste a lesson. Press Enter to send. Shift+Enter for a new line.</div>
  </header>

  <main id="chatbox"></main>

  <!-- Image Preview Section (kept, but not noisy) -->
  <div id="imagePreview">
    <img id="previewImg" alt="Preview">
  </div>

  <footer id="inputArea">
    <div class="composer-row">
      <!-- UI CHANGE: Plus button remains, but now holds *all* secondary controls -->
      <div class="plus-container">
        <button class="plus-btn" type="button" aria-label="More" onclick="toggleUploadMenu(event)">+</button>

        <div id="uploadMenu" class="upload-menu" role="menu" aria-label="Tutor menu">
          <div class="menu-title">Quick Actions</div>
          <!-- Renamed per request -->
          <button class="menu-btn" type="button" onclick="sendContinue()">Continue lesson <span>‚Ü©</span></button>
          <button class="menu-btn" type="button" onclick="interrupt()">Interrupt lesson <span>‚è∏</span></button>

          <div class="menu-title">Tools</div>
          <label class="upload-option" role="menuitem">
            Upload image <span>üì∑</span>
            <input type="file" id="imageInput" accept="image/*" onchange="uploadImage()">
          </label>
          <button class="menu-btn" type="button" onclick="togglePushToTalk()">Push-to-talk toggle <span>üéô</span></button>
          <button class="menu-btn" type="button" onclick="viewProgress()">My progress <span>üìä</span></button>
          <button class="menu-btn" type="button" onclick="clearChat()">Clear chat <span>üóë</span></button>
          <button class="menu-btn" type="button" onclick="setGreetingName()">Change greeting name <span>üßë</span></button>

          <div class="menu-title">Language</div>
          <!-- UI CHANGE: Language select moved into menu (keeps same id/logic) -->
          <div class="field">
            <select id="languageSelect">
              <option value="en">English</option>
              <option value="hi">Hindi</option>
              <option value="kn">Kannada</option>
            </select>
          </div>

          <div class="menu-title">Voice</div>
          <!-- UI CHANGE: Voice gender moved into menu -->
          <div class="menu-row">
            <button class="pill" id="maleBtn" type="button" onclick="setGender('male')">Male</button>
            <button class="pill" id="femaleBtn" type="button" onclick="setGender('female')">Female</button>
          </div>

          <!-- Hidden Voice Select (used internally). Kept to preserve existing voice logic -->
          <select id="voiceType" style="display:none">
            <option value="en-IN-Neural2-A">South Indian English Female</option>
            <option value="en-IN-Neural2-B">South Indian English Male</option>
            <option value="kn-IN-Standard-A">Kannada Female</option>
            <option value="kn-IN-Standard-B">Kannada Male</option>
            <option value="hi-IN-Neural2-A">Hindi Female</option>
            <option value="hi-IN-Neural2-B">Hindi Male</option>
          </select>
        </div>
      </div>

      <div class="input-shell">
        <textarea id="question" placeholder="Ask anything, paste a lesson, or speak..."></textarea>

        <!-- UI CHANGE: Mic icon lives inside the input shell (Speak button removed from main UI) -->
        <button class="icon-btn mic" type="button" aria-label="Speak" onclick="startVoice()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M19 11a7 7 0 0 1-14 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M12 18v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <!-- UI CHANGE: One main Send button (Ask/Continue/Interrupt/Speak removed from main bar) -->
      <button class="send-btn" id="sendBtn" type="button" onclick="send()">Send</button>
    </div>

    <div class="status-row">
      <div id="typing" class="status-warn" style="display:none">AI is thinking...</div>
      <div id="status">Ready</div>
    </div>
  </footer>

  <script>
    // ================= KEEP EXISTING LOGIC (only small wiring for new UI) =================
    let inDoubtMode = false;
    let resumeAfterDoubt = false;
    let aiCurrentlySpeaking = false;
    let autoListening = false;
    let pushToTalk = true;

    let geminiRunning = false;

    let chatbox = document.getElementById("chatbox");
    let currentAudio = null;
    let mediaRecorder;
    let audioChunks = [];

    // UI CHANGE: auto-expand textarea + Enter-to-send (Shift+Enter for newline)
    function autoResizeTextarea(el) {
      el.style.height = "auto";
      const next = Math.min(el.scrollHeight, 160);
      el.style.height = Math.max(next, 48) + "px";
    }

    document.addEventListener("DOMContentLoaded", function () {
      const q = document.getElementById("question");
      q.addEventListener("input", function () {
        inDoubtMode = false; // preserve original behavior: typing cancels doubt mode
        autoResizeTextarea(q);
      });
      q.addEventListener("keydown", function (e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          send();
        }
      });
      autoResizeTextarea(q);
    });

    // -------- PUSH TO TALK TOGGLE --------
    function toggleUploadMenu(event) {
      event.stopPropagation();
      let menu = document.getElementById("uploadMenu");
      if (!menu) return;
      menu.style.display = (menu.style.display === "block") ? "none" : "block";
    }

    document.addEventListener("click", function(event) {
      let menu = document.getElementById("uploadMenu");
      let plusBtn = document.querySelector(".plus-btn");
      if (!menu || !plusBtn) return;
      if (!menu.contains(event.target) && !plusBtn.contains(event.target)) {
        menu.style.display = "none";
      }
    });

    // UI CHANGE: moved toggle into menu (function was referenced in old UI but missing)
    function togglePushToTalk() {
      pushToTalk = !pushToTalk;
      autoListening = !pushToTalk;

      if (!pushToTalk) {
        document.getElementById("status").innerText = "Auto listening is ON";
        geminiMode();
      } else {
        document.getElementById("status").innerText = "Push-to-talk is ON";
      }
    }

    // -------- ADD MESSAGE --------
    function addMessage(text, sender) {
      if (sender === "user" && inDoubtMode) return;

      let div = document.createElement("div");
      div.className = "msg " + sender;

      let time = new Date().toLocaleTimeString();
      let indicator = inDoubtMode ? " (Doubt Mode)" : "";

      div.innerHTML = `
        <div>${text}${indicator}</div>
        <div style="font-size:11px; opacity:0.6; margin-top:6px">${time}</div>
      `;

      chatbox.appendChild(div);
      setTimeout(() => { chatbox.scrollTop = chatbox.scrollHeight; }, 80);
    }

    // -------- SPEAK FUNCTION --------
    function speak(text) {
      if (!text || text.includes("Welcome to AI Interactive Tutor")) {
        resumeAfterDoubt = false;
      }

      stopVoice();

      let selectedVoice = document.getElementById("voiceType").value;

      currentAudio = new Audio(
        "/voice?text=" + encodeURIComponent(text) +
        "&voice=" + selectedVoice
      );

      aiCurrentlySpeaking = true;

      currentAudio.play();

      currentAudio.onended = async function () {
        aiCurrentlySpeaking = false;

        if (resumeAfterDoubt) {
          resumeAfterDoubt = false;

          let lang = document.getElementById("languageSelect").value;
          let askMsg = "Should I continue the lesson? Please say YES or NO.";

          if (lang === "hi") {
            askMsg = "‡§ï‡•ç‡§Ø‡§æ ‡§Æ‡•à‡§Ç ‡§™‡§æ‡§† ‡§ú‡§æ‡§∞‡•Ä ‡§∞‡§ñ‡•Ç‡§Å? ‡§ï‡•É‡§™‡§Ø‡§æ ‡§π‡§æ‡§Å ‡§Ø‡§æ ‡§®‡§æ ‡§¨‡•ã‡§≤‡§ø‡§è‡•§";
          } else if (lang === "kn") {
            askMsg = "‡≤™‡≤æ‡≤†‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤Æ‡≥Å‡≤Ç‡≤¶‡≥Å‡≤µ‡≤∞‡≤ø‡≤∏‡≤¨‡≤π‡≥Å‡≤¶‡≥á? ‡≤¶‡≤Ø‡≤µ‡≤ø‡≤ü‡≥ç‡≤ü‡≥Å ‡≤π‡≥å‡≤¶‡≥Å ‡≤Ö‡≤•‡≤µ‡≤æ ‡≤á‡≤≤‡≥ç‡≤≤ ‡≤é‡≤Ç‡≤¶‡≥Å ‡≤π‡≥á‡≤≥‡≤ø.";
          }

          addMessage(askMsg, "ai");
          speak(askMsg);

          setTimeout(async () => {
            let permission = await listenForSpeech();
            handlePermission(permission);
          }, 2500);
        }
      };
    }

    // UI CHANGE: helper that was referenced but missing; keeps the original flow
    function handlePermission(permissionText) {
      if (!permissionText) return;
      const t = permissionText.toLowerCase();
      if (t.includes("yes") || t.includes("haan") || t.includes("ha") || t.includes("howdu")) {
        sendContinue();
      }
    }

    // -------- MAIN AUTO MODE --------
    async function geminiMode() {
      if (geminiRunning) return;
      geminiRunning = true;

      while (autoListening && !pushToTalk && !inDoubtMode) {
        let userText = await listenForSpeech();
        if (!userText) continue;
        await processUserInput(userText);
      }

      geminiRunning = false;
    }

    // -------- PROCESS USER INPUT --------
    async function processUserInput(text) {
      if (aiCurrentlySpeaking) {
        inDoubtMode = true;
        resumeAfterDoubt = true;

        await fetch("/tutor/pause", { method: "POST" });

        let lang = document.getElementById("languageSelect").value;
        let msg = "Okay, I stopped. What is your doubt? Tell me in your own words.";

        if (lang === "hi") {
          msg = "‡§†‡•Ä‡§ï ‡§π‡•à! ‡§Ü‡§™‡§ï‡§æ ‡§ï‡•ç‡§Ø‡§æ ‡§∏‡§Ç‡§¶‡•á‡§π ‡§π‡•à? ‡§Ü‡§∞‡§æ‡§Æ ‡§∏‡•á ‡§¨‡§§‡§æ‡§á‡§è, ‡§Æ‡•à‡§Ç ‡§∏‡§Æ‡§ù‡§æ‡§ï‡§∞ ‡§Æ‡§¶‡§¶ ‡§ï‡§∞‡•Ç‡§Ç‡§ó‡§æ‡•§";
        } else if (lang === "kn") {
          msg = "‡≤∏‡≤∞‡≤ø! ‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤Ö‡≤®‡≥Å‡≤Æ‡≤æ‡≤® ‡≤è‡≤®‡≥Å? ‡≤®‡≤ø‡≤ß‡≤æ‡≤®‡≤µ‡≤æ‡≤ó‡≤ø ‡≤π‡≥á‡≤≥‡≤ø, ‡≤®‡≤æ‡≤®‡≥Å ‡≤∏‡≥ç‡≤™‡≤∑‡≥ç‡≤ü‡≤µ‡≤æ‡≤ó‡≤ø ‡≤∏‡≤π‡≤æ‡≤Ø ‡≤Æ‡≤æ‡≤°‡≥Å‡≤§‡≥ç‡≤§‡≥á‡≤®‡≥Ü.";
        }

        addMessage(msg, "ai");
        speak(msg);
        return;
      }

      document.getElementById("question").value = text;
      autoResizeTextarea(document.getElementById("question"));
      await send();
    }

    // -------- SEND TO BACKEND --------
    async function send() {
      let q = document.getElementById("question").value;
      if (!q.trim()) return;

      if (q !== "continue") {
        inDoubtMode = false;
      }

      if (!inDoubtMode) {
        addMessage(q, "user");
      }

      document.getElementById("typing").style.display = "block";

      let lang = document.getElementById("languageSelect").value;
      let type = "question";

      if (q.length > 120) {
        type = "lesson";
      }

      if (/[0-9+\-*/=]/.test(q)) {
        q = "Solve this problem step by step like a caring teacher: " + q;
      }

      let res = await fetch("/tutor/ask", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          question: q,
          language: lang,
          input_type: type
        })
      });

      let data = await res.json();

      document.getElementById("typing").style.display = "none";

      addMessage(data.answer, "ai");
      speak(cleanForSpeech(data.answer));

      document.getElementById("question").value = "";
      autoResizeTextarea(document.getElementById("question"));
    }

    // -------- CONTINUE AFTER DOUBT --------
    function sendContinue() {
      aiCurrentlySpeaking = false;
      inDoubtMode = false;
      resumeAfterDoubt = false;
      autoListening = true;

      document.getElementById("question").value = "continue";
      autoResizeTextarea(document.getElementById("question"));
      send();
    }

    // -------- MANUAL INTERRUPT (moved into menu) --------
    async function interrupt() {
      stopVoice();

      inDoubtMode = true;
      autoListening = false;
      pushToTalk = true;

      let lang = document.getElementById("languageSelect").value;
      let msg = "What is your doubt? Please tell me.";

      if (lang === "hi") {
        msg = "‡§Ü‡§™‡§ï‡§æ ‡§∏‡§Ç‡§¶‡•á‡§π ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à? ‡§¨‡•ã‡§≤‡§ø‡§è‡•§";
      } else if (lang === "kn") {
        msg = "‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤Ö‡≤®‡≥Å‡≤Æ‡≤æ‡≤® ‡≤è‡≤®‡≥Å? ‡≤π‡≥á‡≤≥‡≤ø.";
      }

      addMessage(msg, "ai");
      speak(msg);

      await fetch("/tutor/pause", { method: "POST" });

      document.getElementById("question").value = "";
      autoResizeTextarea(document.getElementById("question"));

      setTimeout(() => { startVoice(); }, 2000);
    }

    // -------- CLEAR CHAT --------
    function clearChat() {
      fetch("/tutor/clear");
      chatbox.innerHTML = "";
    }

    // -------- SPEECH CLEANUP --------
    function cleanForSpeech(text) {
      text = text.replace(/#+/g, "");
      text = text.replace(/[*_]/g, "");
      text = text.replace(/[-‚Ä¢]/g, "");
      text = text.replace(/\s+/g, " ").trim();
      return text;
    }

    // -------- LISTEN FOR SPEECH --------
    async function listenForSpeech() {
      return new Promise(async (resolve) => {
        try {
          document.getElementById("status").innerText = "Listening...";

          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          audioChunks = [];

          mediaRecorder.ondataavailable = event => {
            audioChunks.push(event.data);
          };

          mediaRecorder.onstop = async () => {
            document.getElementById("status").innerText = "Understanding...";

            const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
            let formData = new FormData();
            formData.append("audio", audioBlob, "audio.wav");

            let res = await fetch("/speech_to_text", {
              method: "POST",
              body: formData
            });

            let data = await res.json();
            document.getElementById("status").innerText = "Ready";

            let spokenText = (data.text || "").trim();
            if (!spokenText) { resolve(""); return; }

            if (spokenText.toLowerCase().includes("continue")) {
              resolve("continue");
              return;
            }

            resolve(spokenText);
          };

          mediaRecorder.start();

          setTimeout(() => {
            if (mediaRecorder && mediaRecorder.state === "recording") {
              mediaRecorder.stop();
            }
          }, 6000);
        } catch (err) {
          resolve("");
        }
      });
    }

    // -------- PUSH TO TALK START (triggered by mic button) --------
    function startVoice() {
      listenForSpeech().then(text => {
        if (!text) return;
        if (text === "continue") {
          sendContinue();
          return;
        }
        processUserInput(text);
      });
    }

    // -------- STOP VOICE --------
    function stopVoice() {
      if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
      }

      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
      }
    }

    async function viewProgress() {
      let res = await fetch("/tutor/progress_api");
      let data = await res.json();

      let text = "Your Learning Progress:\n\n";
      data.forEach(d => {
        text += "- " + d.topic + " (" + d.language + ")\n";
      });

      addMessage(text, "ai");
    }

    // UI CHANGE: wire image upload to existing backend endpoint (the UI already had this option)
    async function uploadImage() {
      const fileInput = document.getElementById("imageInput");
      const file = fileInput.files && fileInput.files[0];
      if (!file) return;

      const preview = document.getElementById("imagePreview");
      const img = document.getElementById("previewImg");
      img.src = URL.createObjectURL(file);
      preview.style.display = "block";

      document.getElementById("typing").style.display = "block";

      try {
        const formData = new FormData();
        formData.append("image", file);

        const res = await fetch("/tutor/analyze_image", {
          method: "POST",
          body: formData
        });

        const data = await res.json();
        document.getElementById("typing").style.display = "none";

        addMessage("Uploaded an image for explanation.", "user");
        addMessage(data.answer, "ai");
        speak(cleanForSpeech(data.answer));
      } catch (e) {
        document.getElementById("typing").style.display = "none";
        addMessage("Image upload failed. Please try again.", "ai");
      } finally {
        fileInput.value = "";
      }
    }

    // -------- INIT --------
    window.onload = async function() {
      inDoubtMode = false;
      resumeAfterDoubt = false;
      aiCurrentlySpeaking = false;
      autoListening = false;
      pushToTalk = true;

      // Get username from backend
      let res = await fetch("/tutor/get_username");
      let data = await res.json();

      let userName = data.username || "Student";

      // If user already set a custom name, use that
      let customName = localStorage.getItem("ai_greet_name");
      if (customName) userName = customName;

      let hour = new Date().getHours();
      let greeting = "";

      if (hour >= 5 && hour < 12) greeting = "Good Morning ";
      else if (hour >= 12 && hour < 14) greeting = "Good Afternoon ";
      else if (hour >= 17 && hour < 21) greeting = "Good Evening ";
      else greeting = "Good Night ";

      let welcomeText =
        greeting + ", " + userName + "!\n" +
        "Welcome to AI Interactive Tutor.\n" +
        "I am here to help you learn.\n";

      addMessage(welcomeText, "ai");
      setTimeout(() => { speak(welcomeText); }, 800);
    };

    async function setGreetingName() {
      let name = prompt("What name should I call you?");
      if (!name) return;

      localStorage.setItem("ai_greet_name", name);

      await fetch("/tutor/set_nickname", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: name })
      });

      addMessage("Okay! I will greet you as " + name + " from now on.", "ai");
    }

    function setGender(type){
      let lang = document.getElementById("languageSelect").value;
      let voiceSelect = document.getElementById("voiceType");

      let maleBtn = document.getElementById("maleBtn");
      let femaleBtn = document.getElementById("femaleBtn");

      if(type === "male"){
        if(lang === "en") voiceSelect.value = "en-IN-Neural2-B";
        else if(lang === "hi") voiceSelect.value = "hi-IN-Neural2-B";
        else if(lang === "kn") voiceSelect.value = "kn-IN-Standard-B";

        maleBtn.classList.add("active");
        femaleBtn.classList.remove("active");
      }
      else if(type === "female"){
        if(lang === "en") voiceSelect.value = "en-IN-Neural2-A";
        else if(lang === "hi") voiceSelect.value = "hi-IN-Neural2-A";
        else if(lang === "kn") voiceSelect.value = "kn-IN-Standard-A";

        femaleBtn.classList.add("active");
        maleBtn.classList.remove("active");
      }

      localStorage.setItem("voice_gender", type);
    }

    // UI CHANGE: prevent ReferenceError (savedGender was used but never defined)
    const savedGender = localStorage.getItem("voice_gender");
    if(savedGender){
      setGender(savedGender);
    } else {
      setGender("female");
    }

    // Keep voice aligned when language changes
    document.getElementById("languageSelect").addEventListener("change", function () {
      const g = localStorage.getItem("voice_gender") || "female";
      setGender(g);
    });
  </script>
</body>
</html>

