<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Salapa</title>
  <meta name="csrf-token" content="{{ csrf_token() }}">

 <style>
  /* ================= RESET ================= */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

/* ================= VARIABLES ================= */
:root {
  --bg-main: #140b05;
  --bg-panel: #1d120a;
  --bg-chat: #0e0703;

  --primary: #ff9a42;
  --primary-hover: #ff841a;
  --primary-soft: #402413;

  --border-soft: rgba(255, 160, 80, 0.18);
  --shadow-soft: 0 24px 60px rgba(0,0,0,0.55);

  --green: #22c55e;
  --danger: #ef4444;

  --text-main: #fff2e6;
  --text-muted: #cfa78a;
}

/* ================= FULL ORANGE LIGHT MODE ================= */

body.light {

  /* BACKGROUNDS */
  --bg-main: #fff3e0;
  --bg-panel: #ffffff;
  --bg-chat: #fff8f1;

  /* PRIMARY */
  --primary: #fb923c;
  --primary-hover: #f97316;
  --primary-soft: #ffe0bf;

  /* BORDERS / SHADOWS */
  --border-soft: rgba(245, 138, 50, 0.35);
  --shadow-soft: 0 16px 40px rgba(236, 136, 55, 0.28);

  /* TEXT */
  --text-main: #a5550f;
  --text-muted: #9b5114;
}

/* ================= BASE ================= */

html, body {
  height: 100%;
}

body {
  font-family: Inter, system-ui, sans-serif;
  background: radial-gradient(circle at top, #d36123, var(--bg-main));
  color: var(--text-main);
  overflow-y: auto;
}

/* ================= CONTAINER ================= */

.container {
  min-height: calc(100vh - 64px);
}

/* ================= TOPBAR ================= */

.topbar {
  position: fixed;
  inset: 0 0 auto 0;
  height: 64px;
  padding: 0 22px;

  display: flex;
  justify-content: space-between;
  align-items: center;

  background: var(--bg-panel);
  border-bottom: 1px solid var(--border-soft);
  box-shadow: var(--shadow-soft);

  z-index: 1000;
}

/* ================= BUTTONS ================= */

.btn-primary {
  background: linear-gradient(135deg,#ffb066,#ff8a1f);
  color: #2a1408;
  border-radius: 12px;
  padding: 10px 18px;
  font-weight: 700;
  border: none;
  cursor: pointer;
}

.btn-primary:hover {
  background: linear-gradient(135deg,#ff9a42,#ff7a00);
}

.btn-secondary {
  background: transparent;
  color: var(--text-muted);
  border: 1px solid var(--border-soft);
  border-radius: 10px;
  padding: 8px 14px;
  cursor: pointer;
}

.logout { color: var(--text-muted); }

/* ================= APP LAYOUT ================= */

.app-layout {
  padding-top: 64px;
}

/* ================= SIDEBAR ================= */

.sidebar {
  position: fixed;
  top: 64px;
  left: 0;

  width: 260px;
  height: calc(100vh - 64px);

  background: var(--bg-chat);
  border-right: 1px solid var(--border-soft);
  padding: 18px;

  overflow-y: auto;
  overflow-x: hidden;

  display: flex;
  flex-direction: column;
  gap: 12px;

  z-index: 1200;
}

/* ================= SIDEBAR UI ================= */

.sidebar-title {
  font-size: 11px;
  letter-spacing: 1px;
  color: var(--text-muted);
  margin: 18px 0 10px;
}

.sidebar-btn,
.memory-test {
  width: 100%;
  display: block;
  padding: 12px;
  border-radius: 12px;
  margin-top: 10px;

  background: rgba(255,255,255,0.04);
  border: 1px solid var(--border-soft);
  color: var(--text-main);

  font-weight: 700;
  text-decoration: none;
}

.plan-card {
  margin: 6px 0 12px;
  padding: 12px;
  border-radius: 14px;
  border: 1px solid var(--border-soft);
  background: rgba(255,255,255,0.05);
}

.plan-card h4 {
  font-size: 12px;
  letter-spacing: 0.6px;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 6px;
}

.plan-card p {
  font-size: 13px;
  color: var(--text-main);
  margin-bottom: 10px;
}

.plan-card .upgrade-cta {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  padding: 10px 12px;
  border-radius: 12px;
  font-weight: 800;
  text-decoration: none;
  background: linear-gradient(135deg,#ffb066,#ff8a1f);
  color: #2a1408;
}

.locked-hint {
  font-size: 11px;
  color: var(--text-muted);
  margin-top: 6px;
}

.sidebar-btn:hover {
  background: rgba(255,255,255,0.08);
}

.eval-btn,
.memory-test {
  background: linear-gradient(135deg,#16a34a,#22c55e);
  color:#052e16;
}

/* ================= MAIN PANEL ================= */

.main-panel {
  margin-left: 260px;
  padding: 24px;

  display: flex;
  flex-direction: column;
  gap: 16px;
}

/* ================= INPUTS ================= */

input, textarea, select {
  background: var(--bg-panel);
  border: 1px solid var(--border-soft);
  color: var(--text-main);

  padding: 14px;
  border-radius: 12px;
}

input:focus, textarea:focus {
  outline: none;
  border-color: var(--primary);
}

/* ================= AI OUTPUT ================= */

.chat-container {
  background: var(--bg-chat);
  border-radius: 18px;
  padding: 22px;
  border: 1px solid var(--border-soft);
}

/* ================= FOOTER ================= */

.app-footer {
  margin-left: 260px;
  padding: 20px;
  text-align: center;
  color: var(--text-muted);
}

/* ================= LOGIN PAGE ================= */

.login-wrapper {
  min-height: 100vh;
  display: grid;
  place-items: center;
}

.login-card {
  max-width: 420px;
  width: 100%;

  background: var(--bg-panel);
  border: 1px solid var(--border-soft);
  border-radius: 22px;

  padding: 32px;
  box-shadow: var(--shadow-soft);
  text-align: center;
}

.login-card h1 {
  background: linear-gradient(135deg,#ffb066,#ff8a1f);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.divider {
  display:flex;
  align-items:center;
  gap:12px;
  margin:20px 0;
}

.divider:before,
.divider:after {
  content:"";
  flex:1;
  height:1px;
  background:var(--border-soft);
}
/* ===== PREVENT INNER SCROLL ===== */

.main-panel {
  height: auto !important;
  overflow: visible !important;
}

/* Body handles scrolling */
body {
  overflow-y: auto;
}

/* Remove height limits from wrappers */
.container,
.app-layout {
  min-height: unset !important;
  height: auto !important;
}

.view-btn {
  padding: 6px 14px;
  border-radius: 999px;

  font-size: 13px;
  font-weight: 700;

  display: inline-flex;
  align-items: center;
  gap: 6px;

  background: linear-gradient(135deg, #34d399, #22c55e);
  color: #052e16;

  border: none;
  text-decoration: none;

  box-shadow: 
    0 6px 16px rgba(34, 197, 94, 0.28),
    inset 0 1px 0 rgba(255,255,255,0.25);

  transition: 
    transform 0.15s ease,
    box-shadow 0.15s ease,
    filter 0.15s ease;
}

.view-btn:hover {
  transform: translateY(-1px);
  filter: brightness(1.08);
  box-shadow:
    0 10px 22px rgba(34, 197, 94, 0.4);
}

.view-btn:active {
  transform: translateY(0);
}

.delete-btn {
  padding: 6px 14px;
  border-radius: 999px;

  font-size: 13px;
  font-weight: 700;

  display: inline-flex;
  align-items: center;
  gap: 6px;

  background: linear-gradient(135deg, #f87171, #ef4444);
  color: white;

  border: none;
  cursor: pointer;

  box-shadow: 
    0 6px 16px rgba(239, 68, 68, 0.3),
    inset 0 1px 0 rgba(255,255,255,0.2);

  transition:
    transform 0.15s ease,
    box-shadow 0.15s ease,
    filter 0.15s ease;
}

.delete-btn:hover {
  transform: translateY(-1px);
  filter: brightness(1.08);
  box-shadow:
    0 10px 22px rgba(239, 68, 68, 0.45);
}

.delete-btn:active {
  transform: translateY(0);
}

.notes-list li {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
}

/* ================= GOOGLE LOGIN FIX ================= */

.google-btn {
  display: flex;
  align-items: center;
  justify-content: center;

  gap: 10px;

  padding: 12px 18px;

  max-width: 320px;
  margin: 0 auto;

  border-radius: 12px;

  background: rgba(255,255,255,0.05);
  border: 1px solid var(--border-soft);

  font-weight: 700;
  font-size: 14px;

  color: var(--text-main);
  text-decoration: none;

  transition: 0.2s ease;
}

.google-btn:hover {
  background: rgba(255,255,255,0.1);
}

/* üî• THIS IS THE IMPORTANT PART */
.google-btn img {
  width: 18px !important;
  height: 18px !important;

  object-fit: contain;

  flex-shrink: 0;
  display: block;
}

.login-wrapper {
  min-height: 100vh;

  display: flex;
  align-items: center;
  justify-content: center;
}

.login-card {
  max-width: 420px;
  width: 100%;
}


.input-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.auth-actions {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.divider {
  margin: 18px 0;
  text-align: center;
}

.attach-menu {
  position: absolute;

  bottom: 56px;
  left: 8px;

  background: var(--bg-panel);
  border: 1px solid var(--border-soft);
  border-radius: 14px;

  padding: 8px;

  box-shadow: var(--shadow-soft);

  z-index: 2000;

  min-width: 180px;
}

.attach-btn {
  touch-action: manipulation;
}

.input-bar {
  position: relative;
}

/* ================= CAMERA UI ================= */

.camera-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.6);
  backdrop-filter: blur(4px);
  opacity: 0;
  pointer-events: none;
  transition: .25s;
  z-index: 3000;
}

.camera-overlay.active {
  opacity: 1;
  pointer-events: auto;
}

.camera-sheet {
  position: fixed;
  bottom: -100%;
  left: 0;
  width: 100%;
  height: 80vh;

  background: #000;
  border-radius: 22px 22px 0 0;

  display: flex;
  flex-direction: column;

  transition: bottom .3s ease;
  z-index: 4000;
}

.camera-sheet.active {
  bottom: 0;
}

.camera-header {
  display: flex;
  justify-content: space-between;
  align-items: center;

  padding: 14px 18px;
  color: white;
  font-weight: 700;
}

.camera-close {
  background: none;
  border: none;
  font-size: 22px;
  color: white;
  cursor: pointer;
}

#cameraStream {
  flex: 1;
  width: 100%;
  object-fit: cover;
  background: black;
}

.camera-controls {
  padding: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.capture-btn {
  width: 74px;
  height: 74px;
  border-radius: 50%;
  border: 6px solid white;
  background: transparent;
}

.retake-btn {
  background: none;
  color: white;
  font-size: 15px;
  border: none;
}

/* ================= MOBILE ================= */

@media(max-width:900px){

  .sidebar {
    left:-260px;
    transition:left .25s ease;
  }

  .sidebar.open { left:0; }

  .main-panel,
  .app-footer { margin-left:0; }

  .topbar { height:56px; }

  .app-layout { padding-top:56px; }
}

/* ================= OVERLAY ================= */

#overlay {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
}

#overlay.active { display:block; }

.attach-menu {
  left: 50%;
  transform: translateX(-50%);
}
@media(max-width:900px){

  .sidebar-btn,
  .memory-test {
    padding: 10px;
    font-size: 13px;
  }

  .view-btn,
  .delete-btn {
    padding: 5px 10px;
    font-size: 12px;
  }

}


 </style>

<link rel="manifest" href="/static/manifest.json">
<meta name="theme-color" content="#ff8c00">
<link rel="apple-touch-icon" href="/static/icons/icon-192.png">

</head>

<body>

<div id="overlay" onclick="closeSidebar()"></div>
<div class="container">

{% if not username %}

<!-- ================= AUTH PAGE ================= -->
<div class="login-wrapper">
  <div class="login-card">

    <h1>Salapa</h1>

    <p class="login-subtitle">
      Smart notes. Faster revision. Better scores.
    </p>

    <!-- ================= FORM ================= -->

    <form method="POST" id="authForm" action="/login">

      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <!-- USERNAME (hidden initially for register) -->
      <div class="input-group" id="usernameGroup" style="display:none;">
        <label>Username</label>
        <input type="text" name="username">
      </div>

      <!-- EMAIL -->
      <div class="input-group">
        <label>Email address</label>
        <input type="email" name="email" required>
      </div>

      <!-- PASSWORD -->
      <div class="input-group">
        <label>Password</label>
        <input type="password" name="password" required>
      </div>

      <!-- ================= ACTIONS ================= -->

      <div class="auth-actions">

        <button
          type="submit"
          class="btn-primary login-btn"
          id="loginBtn">
          Sign in
        </button>

        <button
          type="button"
          class="btn-secondary login-btn"
          onclick="switchToRegister()">
          Create account
        </button>

      </div>

      <!-- ================= GOOGLE ================= -->

      <div class="divider">
        <span>OR CONTINUE WITH</span>
      </div>

      <a href="/login/google" class="google-btn">
        <img src="https://www.svgrepo.com/show/475656/google-color.svg">
        Sign in with Google
      </a>

    </form>

    <!-- ================= FORGOT PASSWORD ================= -->

    <div class="text-center mt-3">
      <a href="{{ url_for('auth.forgot_password') }}" class="forgot-link">
        Forgot password?
      </a>
    </div>

    <!-- ================= FOOTER ================= -->

    <p class="login-footer">
      By continuing, you agree to our
      <a href="/terms">Terms</a> &
      <a href="/privacy">Privacy Policy</a>
    </p>

  </div>
</div>

<!-- ================= REGISTER SWITCH SCRIPT ================= -->

<script>
function switchToRegister() {

  document.getElementById("usernameGroup").style.display = "block";

  const form = document.getElementById("authForm");
  form.action = "/register";

  document.getElementById("loginBtn").innerText = "Register";
}
</script>

{% else %}

</div>

<!-- ================= TOP BAR ================= -->
<div class="topbar">
   

  <button class="btn-secondary mobile-menu-btn" onclick="toggleSidebar()">
    ‚ò∞
  </button>

  <h2>
    {{ username }}
    {% if plan == "pro" %}
      <span class="badge pro">PRO</span>
    {% else %}
      <span class="badge free">FREE</span>
    {% endif %}
  </h2>

  <div>
    <a href="/settings" class="btn-secondary">‚öôÔ∏è Settings</a>
    <button onclick="toggleTheme()" class="btn-secondary">üåô / ‚òÄÔ∏è</button>
    <a href="/logout" class="logout">Logout</a>

 <button id="installBtn" class="btn-primary" style="display:none;">
  üì≤ Install App
</button>

    {% if username == "admin" %}
      <a href="/admin" class="btn-secondary">üëë Admin</a>
    {% endif %}
  </div>

</div>


<!-- ================= APP LAYOUT ================= -->
<div class="app-layout">

<!-- ===== SIDEBAR ===== -->
<div class="sidebar">

  <div class="sidebar-title">Features</div>

  {% if plan != "pro" %}
  <div class="plan-card">
    <h4>Free Plan</h4>
    <p>Unlock Memory Tests, Evaluations, and more in Pro.</p>
    <a class="upgrade-cta" href="/upgrade">Upgrade to Pro</a>
  </div>
  {% endif %}

  {% if plan == "pro" %}
    <a href="/memory" class="memory-test">üß† Memory Test</a>
  {% else %}
    <button class="memory-test locked" onclick="goPro()">üß† Memory Test</button>
    <div class="locked-hint">Pro feature ‚Ä¢ Tap to upgrade</div>
  {% endif %}

  <hr class="sidebar-divider">

  <div class="sidebar-title">Tools</div>

  <a href="/chat" class="sidebar-btn">üí¨ AI Doubt Chat</a>

  {% if plan == "pro" %}
    <a href="/evaluate" class="sidebar-btn eval-btn">üß† Evaluate Answer</a>
  {% else %}
    <button class="sidebar-btn eval-btn locked" onclick="goPro()">
      üß† Evaluate Answer
    </button>
    <div class="locked-hint">Pro feature ‚Ä¢ Tap to upgrade</div>
  {% endif %}
  
    <a href="/progress" class="sidebar-btn">
  üìä Progress Dashboard
</a>

<a href="/tutor" class="sidebar-btn">ü§ñ AI Tutor</a>

  <hr class="sidebar-divider">

  <button class="sidebar-btn notes-toggle" onclick="toggleNotes()">
    üìö Your Notes <span id="notesArrow">‚ñæ</span>
  </button>

  <div id="notesList" class="notes-wrapper">

    {% if notes|length == 0 %}
      <p style="color: var(--text-muted); font-size: 13px;">
        No notes yet. Generate your first note üìò
      </p>
    {% else %}
      <ul class="notes-list">
        {% for n in notes %}
        <li>
          <span>{{ n["lesson"] }}</span>
          <a href="/note/{{ n['id'] }}" class="view-btn">üëÅ View</a>
          <button class="delete-btn" data-note-id="{{ n['id'] }}">üóë Delete</button>
        </li>
        {% endfor %}
      </ul>
    {% endif %}

  </div>

</div>


<!-- ===== MAIN PANEL ===== -->
<div class="main-panel">

  <h3>Generate Notes</h3>

  <input id="lesson" placeholder="Enter topic (e.g. Cell Structure)">

  <select id="mode">
    <option value="board">Board Exam</option>
    <option value="college">College Exam</option>
    <option value="short">Short Notes</option>

    {% if plan == "pro" %}
      <option value="mcq">MCQ Practice</option>
    {% else %}
      <option value="locked" disabled>MCQ Practice (Pro)</option>
    {% endif %}
  </select>

  <textarea id="user_prompt" rows="6"
    placeholder="Paste your lesson, textbook paragraph, or study material here...">
  </textarea>


  <!-- ===== CHATGPT STYLE INPUT BAR ===== -->
  <div class="input-bar">

    <button class="attach-btn" onclick="toggleMenu()">+</button>

    <div id="attachMenu" class="attach-menu" style="display:none">
      <label for="noteImage" class="menu-item">üì∑ Upload Image</label>
      <span class="menu-item" onclick="openCamera()">üì∏ Capture Photo</span>
    </div>

    <input type="file" id="noteImage" accept="image/*"
           style="display:none" onchange="generateFromImage()">

    <button id="generate-btn" class="btn-primary" onclick="generateNotes()">
      Generate Notes
    </button>

  </div>


  <!-- ===== LOADER ===== -->
  <div id="aiLoader" class="ai-loader" style="display:none;">
    <div class="rotator"></div>
    <span>AI is generating notes‚Ä¶</span>
  </div>

  <!-- ===== AI OUTPUT ===== -->
  <div id="chat" class="chat-container"></div>

</div>

</div>

{% endif %}

</div>

<!-- ================= CAMERA SHEET ================= -->
<div id="cameraOverlay" class="camera-overlay" onclick="closeCamera()"></div>

<div id="cameraSheet" class="camera-sheet">

  <div class="camera-header">
    <span>Scan with Camera</span>
    <button onclick="closeCamera()" class="camera-close">‚úï</button>
  </div>

  <video id="cameraStream" autoplay playsinline></video>

  <div class="camera-controls">
    <button class="retake-btn" onclick="closeCamera()">Cancel</button>

    <button class="capture-btn" onclick="capturePhoto()"></button>
  </div>

  <canvas id="photoCanvas" style="display:none;"></canvas>

</div>



<footer class="app-footer">
  <a href="/privacy">Privacy Policy</a>
  <span>‚Ä¢</span>
  <a href="/terms">Terms & Conditions</a>
</footer>

<script>
// ----- IMAGE OCR GENERATION -----
async function generateFromImage() {

    let fileInput = document.getElementById("noteImage");

    if (!fileInput || !fileInput.files.length) {
        alert("Please select an image first");
        return;
    }

    let formData = new FormData();

    formData.append("image", fileInput.files[0]);

    let mode = document.getElementById("mode").value;
    formData.append("mode", mode);

    let csrf = document.querySelector('meta[name="csrf-token"]').content;
    formData.append("csrf_token", csrf);

    document.getElementById("aiLoader").style.display = "flex";

    let res = await fetch("/generate_from_image", {
        method: "POST",
        body: formData
    });

    document.getElementById("aiLoader").style.display = "none";

    let text = await res.text();

    document.getElementById("chat").innerText = text;
}


// ----- ATTACH MENU TOGGLE -----
function toggleMenu() {

    let menu = document.getElementById("attachMenu");

    if (!menu) return;

    menu.style.display =
        menu.style.display === "none" ? "block" : "none";
}


let cameraStreamRef = null;

function openCamera() {

  document.getElementById("attachMenu").style.display = "none";

  document.getElementById("cameraOverlay").classList.add("active");
  document.getElementById("cameraSheet").classList.add("active");

  navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" }
  }).then(stream => {

    cameraStreamRef = stream;

    const video = document.getElementById("cameraStream");
    video.srcObject = stream;

  }).catch(() => {
    alert("Camera not available");
    closeCamera();
  });
}

function closeCamera() {

  document.getElementById("cameraOverlay").classList.remove("active");
  document.getElementById("cameraSheet").classList.remove("active");

  if (cameraStreamRef) {
    cameraStreamRef.getTracks().forEach(t => t.stop());
    cameraStreamRef = null;
  }
}

function capturePhoto() {

  const video = document.getElementById("cameraStream");
  const canvas = document.getElementById("photoCanvas");

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  const ctx = canvas.getContext("2d");
  ctx.drawImage(video, 0, 0);

  canvas.toBlob(blob => {

    const file = new File([blob], "camera.png", { type: "image/png" });

    uploadCapturedImage(file);

  });

  closeCamera();
}


async function uploadCapturedImage(file) {

    let formData = new FormData();

    formData.append("image", file);

    let csrf = document.querySelector('meta[name="csrf-token"]').content;
    formData.append("csrf_token", csrf);

    document.getElementById("aiLoader").style.display = "flex";

    let res = await fetch("/generate_from_image", {
        method: "POST",
        body: formData
    });

    document.getElementById("aiLoader").style.display = "none";

    let text = await res.text();

    document.getElementById("chat").innerText = text;
}

async function generateNotes() {

    let lesson = document.getElementById("lesson").value.trim();
    let mode = document.getElementById("mode").value;
    let userPrompt = document.getElementById("user_prompt").value.trim();

    if (!lesson) {
        alert("Please enter a topic first");
        return;
    }

    let csrf = document.querySelector('meta[name="csrf-token"]').content;

    let formData = new FormData();
    formData.append("lesson", lesson);
    formData.append("mode", mode);
    formData.append("user_prompt", userPrompt);
    formData.append("csrf_token", csrf);

    document.getElementById("aiLoader").style.display = "flex";

    try {

        let res = await fetch("/generate_stream", {
            method: "POST",
            body: formData
        });

        document.getElementById("aiLoader").style.display = "none";

        if (!res.ok) {
            let err = await res.text();
            alert(err);
            return;
        }

        let text = await res.text();

        document.getElementById("chat").innerText = text;

    } catch (e) {
        document.getElementById("aiLoader").style.display = "none";
        alert("Failed to generate notes");
    }
}

function toggleTheme() {

    let body = document.body;

    // Toggle light class
    body.classList.toggle("light");

    // Save preference
    if (body.classList.contains("light")) {
        localStorage.setItem("theme", "light");
    } else {
        localStorage.setItem("theme", "dark");
    }
}

// Load saved theme on page load
window.addEventListener("load", () => {

    let saved = localStorage.getItem("theme");

    if (saved === "light") {
        document.body.classList.add("light");
    }
});

// ================= SIDEBAR MOBILE TOGGLE =================

function toggleSidebar() {

  const sidebar = document.querySelector(".sidebar");
  const overlay = document.getElementById("overlay");

  sidebar.classList.toggle("open");
  overlay.classList.toggle("active");
}

function closeSidebar() {

  const sidebar = document.querySelector(".sidebar");
  const overlay = document.getElementById("overlay");

  sidebar.classList.remove("open");
  overlay.classList.remove("active");
}

// ================= UPGRADE REDIRECT =================
function goPro() {
  window.location.href = "/pricing";
}

// ================= DELETE NOTE =================

document.addEventListener("click", async function (e) {

  if (!e.target.classList.contains("delete-btn")) return;

  const btn = e.target;
  const noteId = btn.dataset.noteId;

  if (!noteId) return;

  if (!confirm("Delete this note permanently?")) return;

  const csrf = document.querySelector('meta[name="csrf-token"]').content;

  try {

    const res = await fetch(`/delete_note/${noteId}`, {
      method: "POST",
      headers: {
        "X-CSRF-Token": csrf
      }
    });

    if (!res.ok) {
      const err = await res.text();
      alert(err || "Delete failed");
      return;
    }

    // Remove from UI
    btn.closest("li").remove();

  } catch (err) {
    alert("Network error while deleting");
  }
});


if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/static/sw.js");
}

let deferredPrompt;
const installBtn = document.getElementById("installBtn");

window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;

  if (installBtn) {
    installBtn.style.display = "inline-flex";
  }
});

if (installBtn) {
  installBtn.addEventListener("click", async () => {
    if (!deferredPrompt) return;

    deferredPrompt.prompt();

    const choice = await deferredPrompt.userChoice;

    if (choice.outcome === "accepted") {
      console.log("User installed app");
    }

    deferredPrompt = null;
    installBtn.style.display = "none";
  });
}

window.addEventListener("appinstalled", () => {
  if (installBtn) {
    installBtn.style.display = "none";
  }
});

</script>

</body>
</html>
